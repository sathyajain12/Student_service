/** =========================================== */
/** APPROVAL PROCESSING SYSTEM                 */
/** Based on existing email reply patterns     */
/** =========================================== */

/**
 * This function should be triggered by a time-based trigger (every 5-10 minutes)
 * to check for Director and Controller approval/rejection emails
 */
function processApprovals() {
  const lock = LockService.getScriptLock();
  
  try {
    if (!lock.tryLock(1000)) {
      Logger.log('Another process is running. Skipping...');
      return;
    }
    
    if (!shouldProcess()) {
      Logger.log('Not enough time since last run. Skipping...');
      return;
    }
    
    const results = {
      duplicateGradeCard: processFormApprovals(CONFIG.SHEETS.DUPLICATE_GRADE_CARD),
      supplementaryExam: processFormApprovals(CONFIG.SHEETS.SUPPLEMENTARY_EXAM),
      nameChange: processFormApprovals(CONFIG.SHEETS.NAME_CHANGE),
      duplicateDegree: processFormApprovals(CONFIG.SHEETS.DUPLICATE_DEGREE)
    };
    
    // Update last run time
    PropertiesService.getScriptProperties().setProperty('lastProcessTime', Date.now().toString());
    
    Logger.log('Processing complete: ' + JSON.stringify(results));
    
  } catch (e) {
    Logger.log('Error in processApprovals: ' + e.toString());
  } finally {
    lock.releaseLock();
  }
}

function shouldProcess() {
  const lastRun = PropertiesService.getScriptProperties().getProperty('lastProcessTime');
  if (!lastRun) return true;
  
  const now = Date.now();
  const timeSinceLastRun = now - parseInt(lastRun);
  
  // Only process if at least 5 minutes have passed
  return timeSinceLastRun >= 300000;
}

function processFormApprovals(sheetName) {
  try {
    const sheet = getSheet(sheetName);
    const data = sheet.getDataRange().getValues();
    
    if (data.length <= 1) {
      return { processed: 0, errors: 0 };
    }
    
    // Process Director approvals
    const directorResults = processDirectorApprovalsForSheet(sheet, data);
    
    // Process Controller approvals (for apps that director approved)
    const controllerResults = processControllerApprovalsForSheet(sheet, data);
    
    return {
      director: directorResults,
      controller: controllerResults
    };
    
  } catch (error) {
    Logger.log('Error processing approvals for ' + sheetName + ': ' + error.toString());
    return { error: error.message };
  }
}

function processDirectorApprovalsForSheet(sheet, data) {
  const searchQuery = buildSearchQuery('Director');
  const threads = GmailApp.search(searchQuery);
  
  if (!threads.length) {
    return { processed: 0, errors: 0 };
  }
  
  let processed = 0;
  let errors = 0;
  
  const messages = GmailApp.getMessagesForThreads(threads).flat();
  
  messages.forEach(msg => {
    try {
      const { appId, action, comments } = parseApprovalEmail(msg);
      if (!appId) return;
      
      // Find row with this app ID
      const rowIndex = findRowByAppId(data, appId);
      if (!rowIndex) {
        Logger.log('AppId ' + appId + ' not found in sheet');
        return;
      }
      
      const row = data[rowIndex - 1];
      
      // Update Director columns (assuming columns 16, 17, 18)
      sheet.getRange(rowIndex, 16).setValue(action); // Director Status
      sheet.getRange(rowIndex, 17).setValue(comments); // Director Comments
      sheet.getRange(rowIndex, 18).setValue(new Date()); // Director Date
      
      // Set background color
      if (action === 'Approved') {
        sheet.getRange(rowIndex, 16).setBackground('#d1fae5'); // Green
        
        // Send to controller
        notifyControllerAfterDirectorApproval(row, appId, sheet.getName());
        
        // Notify student
        notifyStudentDirectorApproved(row, appId);
        
      } else if (action === 'Rejected') {
        sheet.getRange(rowIndex, 16).setBackground('#fee2e2'); // Red
        sheet.getRange(rowIndex, 22).setValue('Rejected by Director'); // Final Status
        
        // Notify student
        notifyStudentDirectorRejected(row, appId, comments);
      }
      
      msg.markRead();
      processed++;
      
    } catch (e) {
      Logger.log('Error processing director message: ' + e.toString());
      errors++;
    }
  });
  
  return { processed, errors };
}

function processControllerApprovalsForSheet(sheet, data) {
  const searchQuery = buildSearchQuery('Controller');
  const threads = GmailApp.search(searchQuery);
  
  if (!threads.length) {
    return { processed: 0, errors: 0 };
  }
  
  let processed = 0;
  let errors = 0;
  
  const messages = GmailApp.getMessagesForThreads(threads).flat();
  
  messages.forEach(msg => {
    try {
      const { appId, action, comments } = parseApprovalEmail(msg);
      if (!appId) return;
      
      // Find row with this app ID
      const rowIndex = findRowByAppId(data, appId);
      if (!rowIndex) {
        Logger.log('AppId ' + appId + ' not found in sheet');
        return;
      }
      
      const row = data[rowIndex - 1];
      
      // Update Controller columns (assuming columns 19, 20, 21)
      sheet.getRange(rowIndex, 19).setValue(action); // Controller Status
      sheet.getRange(rowIndex, 20).setValue(comments); // Controller Comments
      sheet.getRange(rowIndex, 21).setValue(new Date()); // Controller Date
      
      // Set background color
      if (action === 'Approved') {
        sheet.getRange(rowIndex, 19).setBackground('#d1fae5'); // Green
        sheet.getRange(rowIndex, 22).setValue('Fully Approved'); // Final Status
        
        // Notify student
        notifyStudentFullyApproved(row, appId);
        
      } else if (action === 'Rejected') {
        sheet.getRange(rowIndex, 19).setBackground('#fee2e2'); // Red
        sheet.getRange(rowIndex, 22).setValue('Rejected by Controller'); // Final Status
        
        // Notify student
        notifyStudentControllerRejected(row, appId, comments);
      }
      
      msg.markRead();
      processed++;
      
    } catch (e) {
      Logger.log('Error processing controller message: ' + e.toString());
      errors++;
    }
  });
  
  return { processed, errors };
}

function buildSearchQuery(role) {
  const days = CONFIG.GMAIL_SEARCH_DAYS;
  const date = new Date(Date.now() - days * 24 * 60 * 60 * 1000);
  const dateStr = Utilities.formatDate(date, Session.getScriptTimeZone(), 'yyyy/MM/dd');
  
  return `is:unread (subject:"${role} Approve" OR subject:"${role} Reject") after:${dateStr}`;
}

function parseApprovalEmail(msg) {
  const subject = msg.getSubject();
  const body = msg.getPlainBody();
  
  // Extract APP-ID from subject
  const appIdMatch = subject.match(/APP-\d+/);
  if (!appIdMatch) return { appId: null };
  
  const appId = appIdMatch[0];
  let action = '';
  let comments = '';
  
  if (subject.includes('Approve')) {
    action = 'Approved';
  } else if (subject.includes('Reject')) {
    action = 'Rejected';
    // Extract comments from body
    comments = body.replace(/\s+/g, ' ').trim();
  }
  
  return { appId, action, comments };
}

function findRowByAppId(data, appId) {
  for (let i = 1; i < data.length; i++) {
    if (data[i][1] === appId) { // Column 2 is Application ID (index 1)
      return i + 1; // Return 1-based row number
    }
  }
  return null;
}

/** =========================================== */
/** NOTIFICATION FUNCTIONS                     */
/** =========================================== */

function notifyControllerAfterDirectorApproval(row, appId, formType) {
  const studentName = row[3]; // Assuming column 4 is name
  const studentEmail = row[2]; // Assuming column 3 is email
  const regNo = row[5]; // Assuming column 6 is registration number
  
  const approveMailBody = encodeURIComponent(
    `Dear Student Services,\n\nThe Director has approved application (${appId}).\nI hereby APPROVE this application for final processing.\n\nRegards,\nController`
  );
  
  const rejectMailBody = encodeURIComponent(
    `Dear Student Services,\n\nThe Director has approved application (${appId}).\nHowever, I REJECT this application.\n\nComments:\n--------------------------------------------------\n`
  );
  
  const approveMailto = `mailto:${CONFIG.CONTROLLER_EMAIL}?subject=Controller%20Approve%20${appId}&body=${approveMailBody}`;
  const rejectMailto = `mailto:${CONFIG.CONTROLLER_EMAIL}?subject=Controller%20Reject%20${appId}&body=${rejectMailBody}`;
  
  const htmlBody = `
    <div style="font-family: Arial, sans-serif; max-width: 600px; margin: 0 auto;">
      <div style="background: #1e3a8a; color: white; padding: 20px; text-align: center;">
        <h2>üìã Controller Review Required</h2>
      </div>
      
      <div style="padding: 30px; background: #f9fafb;">
        <p style="font-size: 16px;">Dear Controller,</p>
        
        <p style="font-size: 14px; line-height: 1.6;">
          The Director has <strong style="color: #059669;">APPROVED</strong> the following application. 
          Please review for final approval.
        </p>
        
        <div style="background: white; padding: 20px; border-radius: 8px; margin: 20px 0; border-left: 4px solid #1e40af;">
          <h3 style="color: #1e3a8a;">Application Details</h3>
          <p><strong>Application ID:</strong> ${appId}</p>
          <p><strong>Form Type:</strong> ${formType}</p>
          <p><strong>Student Name:</strong> ${studentName}</p>
          <p><strong>Registration No:</strong> ${regNo}</p>
          <p><strong>Email:</strong> ${studentEmail}</p>
        </div>
        
        <div style="text-align: center; margin: 30px 0;">
          <a href="${approveMailto}" 
             style="display: inline-block; background: #059669; color: white; padding: 15px 30px; 
                    text-decoration: none; border-radius: 8px; margin: 0 10px; font-weight: bold;">
            ‚úÖ APPROVE
          </a>
          <a href="${rejectMailto}" 
             style="display: inline-block; background: #dc2626; color: white; padding: 15px 30px; 
                    text-decoration: none; border-radius: 8px; margin: 0 10px; font-weight: bold;">
            ‚ùå REJECT
          </a>
        </div>
      </div>
      
      <div style="background: #f3f4f6; padding: 20px; text-align: center; color: #6b7280; font-size: 12px;">
        <p>Student Services Portal - SSSIHL</p>
      </div>
    </div>
  `;
  
  sendEmail({
    to: CONFIG.CONTROLLER_EMAIL,
    subject: `Controller Review Required - Application ${appId}`,
    htmlBody: htmlBody
  });
}

function notifyStudentDirectorApproved(row, appId) {
  const studentName = row[3];
  const studentEmail = row[2];
  
  const htmlBody = `
    <div style="font-family: Arial, sans-serif; max-width: 600px; margin: 0 auto;">
      <div style="background: #059669; color: white; padding: 20px; text-align: center;">
        <h2>‚úÖ Director Approved</h2>
      </div>
      
      <div style="padding: 30px; background: #f9fafb;">
        <p>Dear ${studentName},</p>
        
        <p>Good news! Your application <strong>${appId}</strong> has been <strong style="color: #059669;">APPROVED by the Director</strong>.</p>
        
        <div style="background: #d1fae5; padding: 15px; border-radius: 8px; margin: 20px 0;">
          <p style="margin: 0; color: #065f46;">
            Your application has now been forwarded to the <strong>Controller</strong> for final review.
          </p>
        </div>
        
        <p>You will receive another email notification once the Controller completes the review.</p>
      </div>
      
      <div style="background: #f3f4f6; padding: 20px; text-align: center; color: #6b7280; font-size: 12px;">
        <p>Student Services Portal - SSSIHL</p>
      </div>
    </div>
  `;
  
  sendEmail({
    to: studentEmail,
    subject: `Update: Director Approved Application ${appId}`,
    htmlBody: htmlBody
  });
}

function notifyStudentDirectorRejected(row, appId, comments) {
  const studentName = row[3];
  const studentEmail = row[2];
  
  const htmlBody = `
    <div style="font-family: Arial, sans-serif; max-width: 600px; margin: 0 auto;">
      <div style="background: #dc2626; color: white; padding: 20px; text-align: center;">
        <h2>‚ùå Application Rejected</h2>
      </div>
      
      <div style="padding: 30px; background: #f9fafb;">
        <p>Dear ${studentName},</p>
        
        <p>Your application <strong>${appId}</strong> has been <strong style="color: #dc2626;">REJECTED by the Director</strong>.</p>
        
        <div style="background: #fee2e2; padding: 15px; border-radius: 8px; margin: 20px 0;">
          <h4 style="color: #991b1b; margin-bottom: 8px;">Comments:</h4>
          <p style="margin: 0; color: #7f1d1d;">${comments || 'No specific comments provided'}</p>
        </div>
        
        <p>For further clarification, please contact the Director's office or email controller@sssihl.edu.in</p>
      </div>
      
      <div style="background: #f3f4f6; padding: 20px; text-align: center; color: #6b7280; font-size: 12px;">
        <p>Student Services Portal - SSSIHL</p>
      </div>
    </div>
  `;
  
  sendEmail({
    to: studentEmail,
    subject: `Application Rejected: ${appId}`,
    htmlBody: htmlBody
  });
}

function notifyStudentFullyApproved(row, appId) {
  const studentName = row[3];
  const studentEmail = row[2];
  
  const htmlBody = `
    <div style="font-family: Arial, sans-serif; max-width: 600px; margin: 0 auto;">
      <div style="background: #059669; color: white; padding: 20px; text-align: center;">
        <h2>üéâ Application Fully Approved!</h2>
      </div>
      
      <div style="padding: 30px; background: #f9fafb;">
        <p>Dear ${studentName},</p>
        
        <p style="font-size: 16px; color: #065f46; font-weight: bold;">
          Congratulations! Your application <strong>${appId}</strong> has been fully approved.
        </p>
        
        <div style="background: #d1fae5; padding: 20px; border-radius: 8px; margin: 20px 0; text-align: center;">
          <p style="margin: 0; font-size: 18px; color: #047857;">
            ‚úÖ Approved by Director<br>
            ‚úÖ Approved by Controller
          </p>
        </div>
        
        <div style="background: #eff6ff; padding: 15px; border-radius: 8px;">
          <h4 style="color: #1e3a8a; margin-bottom: 10px;">What's Next?</h4>
          <p style="margin: 0; color: #1e40af;">
            Your documents will be processed and you will be notified when they are ready for collection.
            For queries, contact: controller@sssihl.edu.in
          </p>
        </div>
      </div>
      
      <div style="background: #f3f4f6; padding: 20px; text-align: center; color: #6b7280; font-size: 12px;">
        <p>Student Services Portal - SSSIHL</p>
      </div>
    </div>
  `;
  
  sendEmail({
    to: studentEmail,
    subject: `Application Approved: ${appId}`,
    htmlBody: htmlBody
  });
}

function notifyStudentControllerRejected(row, appId, comments) {
  const studentName = row[3];
  const studentEmail = row[2];
  
  const htmlBody = `
    <div style="font-family: Arial, sans-serif; max-width: 600px; margin: 0 auto;">
      <div style="background: #dc2626; color: white; padding: 20px; text-align: center;">
        <h2>‚ùå Application Rejected by Controller</h2>
      </div>
      
      <div style="padding: 30px; background: #f9fafb;">
        <p>Dear ${studentName},</p>
        
        <p>Your application <strong>${appId}</strong> was initially approved by the Director but has been <strong style="color: #dc2626;">REJECTED by the Controller</strong>.</p>
        
        <div style="background: #fee2e2; padding: 15px; border-radius: 8px; margin: 20px 0;">
          <h4 style="color: #991b1b; margin-bottom: 8px;">Comments:</h4>
          <p style="margin: 0; color: #7f1d1d;">${comments || 'No specific comments provided'}</p>
        </div>
        
        <p>For further clarification, please contact: controller@sssihl.edu.in</p>
      </div>
      
      <div style="background: #f3f4f6; padding: 20px; text-align: center; color: #6b7280; font-size: 12px;">
        <p>Student Services Portal - SSSIHL</p>
      </div>
    </div>
  `;
  
  sendEmail({
    to: studentEmail,
    subject: `Application Rejected by Controller: ${appId}`,
    htmlBody: htmlBody
  });
}