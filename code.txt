/** =========================================== */
/** GLOBAL CONFIGURATION                       */
/** =========================================== */
const CONFIG = {
  // Single spreadsheet with 9 sheets
  SPREADSHEET_ID: '14tGuQMh8JYS0dXLRYvBDH79s30SAeNi_SDFHjCWbkAo', // Replace with actual ID
  
  // Sheet names for each form type
  SHEETS: {
    DUPLICATE_GRADE_CARD: 'Duplicate Grade Card',
    CGPA_CONVERSION: 'CGPA Conversion',
    SUPPLEMENTARY_EXAM: 'Supplementary Exam',
    DUPLICATE_DEGREE: 'Duplicate Degree',
    NAME_CHANGE: 'Name Change',
    REPEAT_PAPER: 'Repeat Paper',
    RETOTALING: 'Re-totaling',
    ON_REQUEST_DEGREE: 'On-Request Degree',
    MIGRATION: 'Migration Certificate'
  },
  
  // Campus Director emails
  CAMPUS_DIRECTORS: {
    'Prashanti Nilayam Campus': 'saisathyajain@sssihl.edu.in',
    'Anantapur Campus': 'results@sssihl.edu.in',
    'Brindavan Campus': 'sathyajain9@gmail.com',
    'Nandigiri Campus': 'sathyajain99@outlook.com'
  },
  
  // Controller email
  CONTROLLER_EMAIL: 'manilkumar@sssihl.edu.in',
  
  // File upload settings
  FILE_SIZE_LIMIT: 1073741824, // 1 GB in bytes
  ALLOWED_FILE_TYPES: [
    'application/pdf'
  ],
  
  // Google Drive folder for uploads
  UPLOAD_FOLDER_ID: '1wD2uYFFK6qhKpOz4NRYaoZSLxB_70izM', // Replace with actual folder ID
  
  // Email batch settings
  EMAIL_BATCH_SIZE: 10,
  GMAIL_SEARCH_DAYS: 1,
  
  // Lock settings
  LOCK_TIMEOUT: 30000 // 30 seconds
};

/** =========================================== */
/** WEB APP HANDLER - SERVES PORTAL & FORMS    */
/** =========================================== */
function doGet(e) {
  const page = e.parameter.page || 'portal';
  
  try {
    switch(page) {
      case 'portal':
        return HtmlService.createHtmlOutputFromFile('Portal')
          .setTitle('Examination Services Portal - SSSIHL')
          .setXFrameOptionsMode(HtmlService.XFrameOptionsMode.ALLOWALL);
      
      case 'duplicate-grade-card':
        return HtmlService.createHtmlOutputFromFile('Form_DuplicateGradeCard')
          .setTitle('Application for Duplicate Grade Card')
          .setXFrameOptionsMode(HtmlService.XFrameOptionsMode.ALLOWALL);
      
      case 'cgpa-conversion':
        return HtmlService.createHtmlOutputFromFile('Form_CGPAConversion')
          .setTitle('Application for CGPA to Marks Conversion')
          .setXFrameOptionsMode(HtmlService.XFrameOptionsMode.ALLOWALL);
      
      case 'supplementary-exam':
        return HtmlService.createHtmlOutputFromFile('Form_SupplementaryExam')
          .setTitle('Application for End-Semester Supplementary Examinations')
          .setXFrameOptionsMode(HtmlService.XFrameOptionsMode.ALLOWALL);
      
      case 'duplicate-degree':
        return HtmlService.createHtmlOutputFromFile('Form_DuplicateDegree')
          .setTitle('Application for Duplicate Degree Certificate')
          .setXFrameOptionsMode(HtmlService.XFrameOptionsMode.ALLOWALL);
      
      case 'name-change':
        return HtmlService.createHtmlOutputFromFile('Form_NameChange')
          .setTitle('Application for Name Change Registration')
          .setXFrameOptionsMode(HtmlService.XFrameOptionsMode.ALLOWALL);
      
      case 'repeat-paper':
        return HtmlService.createHtmlOutputFromFile('Form_RepeatPaper')
          .setTitle('Application for Repeating Paper')
          .setXFrameOptionsMode(HtmlService.XFrameOptionsMode.ALLOWALL);
      
      case 'retotaling':
        return HtmlService.createHtmlOutputFromFile('Form_Retotaling')
          .setTitle('Application for Re-Totaling of Marks')
          .setXFrameOptionsMode(HtmlService.XFrameOptionsMode.ALLOWALL);
      
      case 'on-request-degree':
        return HtmlService.createHtmlOutputFromFile('Form_OnRequestDegree')
          .setTitle('On-Request Degree Certificate Issue')
          .setXFrameOptionsMode(HtmlService.XFrameOptionsMode.ALLOWALL);
      
      case 'migration':
        return HtmlService.createHtmlOutputFromFile('Form_Migration')
          .setTitle('Application for Migration Certificate')
          .setXFrameOptionsMode(HtmlService.XFrameOptionsMode.ALLOWALL);
      
      default:
        return HtmlService.createHtmlOutput('<h1>Page not found</h1>')
          .setTitle('Error - SSSIHL');
    }
  } catch (error) {
    Logger.log('Error in doGet: ' + error.toString());
    return HtmlService.createHtmlOutput('<h1>Error loading page</h1><p>' + error.toString() + '</p>')
      .setTitle('Error - SSSIHL');
  }
}

/** =========================================== */
/** UTILITY FUNCTIONS                          */
/** =========================================== */
function generateAppId() {
  return "APP-" + Date.now();
}

function getDirectorEmail(campus) {
  return CONFIG.CAMPUS_DIRECTORS[campus] || CONFIG.CAMPUS_DIRECTORS['Prashanti Nilayam Campus'];
}

function getSpreadsheet() {
  return SpreadsheetApp.openById(CONFIG.SPREADSHEET_ID);
}

function getSheet(sheetName) {
  const ss = getSpreadsheet();
  let sheet = ss.getSheetByName(sheetName);
  
  // Create sheet if it doesn't exist
  if (!sheet) {
    sheet = ss.insertSheet(sheetName);
    initializeSheet(sheet, sheetName);
  }
  
  return sheet;
}

function initializeSheet(sheet, sheetName) {
  // This will be customized per form type
  const headers = ['Timestamp', 'Application ID', 'Email', 'Status', 'Director Approval', 'Controller Approval', 'Comments'];
  sheet.getRange(1, 1, 1, headers.length).setValues([headers]);
  sheet.getRange(1, 1, 1, headers.length).setFontWeight('bold').setBackground('#1e3a8a').setFontColor('white');
  sheet.setFrozenRows(1);
}

function sendEmail(params) {
  try {
    MailApp.sendEmail(params);
    return true;
  } catch (e) {
    Logger.log('Email send error: ' + e.toString());
    return false;
  }
}

function uploadFileToDrive(fileBlob, fileName, formType) {
  try {
    const folder = DriveApp.getFolderById(CONFIG.UPLOAD_FOLDER_ID);
    
    // Create subfolder for form type if it doesn't exist
    let subFolder;
    const subFolders = folder.getFoldersByName(formType);
    if (subFolders.hasNext()) {
      subFolder = subFolders.next();
    } else {
      subFolder = folder.createFolder(formType);
    }
    
    // Upload file
    const file = subFolder.createFile(fileBlob);
    file.setName(fileName);
    
    return {
      success: true,
      fileId: file.getId(),
      fileUrl: file.getUrl(),
      fileName: file.getName()
    };
  } catch (error) {
    Logger.log('File upload error: ' + error.toString());
    return {
      success: false,
      error: error.toString()
    };
  }
}

/** =========================================== */
/** FILE HANDLING                              */
/** =========================================== */
function processFileUpload(base64Data, fileName, mimeType) {
  try {
    // Decode base64
    const data = base64Data.split(',')[1] || base64Data;
    const blob = Utilities.newBlob(Utilities.base64Decode(data), mimeType, fileName);
    
    // Check file size
    if (blob.getBytes().length > CONFIG.FILE_SIZE_LIMIT) {
      return {
        success: false,
        error: 'File size exceeds 1 GB limit'
      };
    }
    
    return blob;
  } catch (error) {
    Logger.log('File processing error: ' + error.toString());
    return {
      success: false,
      error: error.toString()
    };
  }
}